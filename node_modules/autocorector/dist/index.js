#!/usr/bin/env node

var { spawn, execSync } = require('child_process');
var opsys = process.platform;
var suffix = "Linux";

var isUpload = false;
var myArgs = process.argv.slice(2);
console.log("\n");

(function checkArgs () {
	for (var i = 0; i < myArgs.length; i++) {
		var arg = myArgs[i].trim();
		switch (arg) {
			case "--help":
			case "-h":
				console.info(`


                _         _____ ____  _____  ______     _             
               | |       / ____/ __ \\|  __ \\|  ____|   | |            
     ____ _   _| |_ ___ | |   | |  | | |__) | |__   ___| |_ ___  _ __ 
    / _  | | | | __/ _ \\| |   | |  | |  _  /|  __| / __| __/ _ \\| '__|
   | (_| | |_| | || (_) | |___| |__| | | \\ \\| |___| (__| || (_) | |   
    \\__,_|\\__,_|\\__\\___/ \\_____\\____/|_|  \\_|______\\___|\\__\\___/|_|   
                                                                      
                                                                
  Herramienta de autocorrección de la asignatura CORE

  Uso:
    Si se ha instalado como paquete global
     $ autocorector [OPCIONES]
    Si se ha instalado como paquete local
     $ npx autocorector # desde el directorio donde está el package.json de la práctica

  Opciones:
    [sin opciones]: Pasa los tests en local. No tiene impacto sobre la nota final
    -u, --upload:   Pasa los tests en local y sube la entrega y calificación obtenida a Moodle
    -h, --help:     Ayuda sobre los comandos disponibles en la herramienta
    -v, --version:  Comprueba la versión del autoCOREctor
	`)
				process.exit(0);
				return;
			case "--version":
			case "-v":
				var currentVersion = require('../package.json').version;
				var latestVersion = undefined;
				try {
					latestVersion = execSync("npm show autocorector version").toString().trim();
					if (latestVersion === currentVersion) {
						console.log("Tienes la última versión del autoCOREctor (" + currentVersion + ")\n")
					} else {
						console.log("No tienes la última versión del autoCOREctor (" + latestVersion + "). La versión instalada es la " + currentVersion);
						console.log("\nPara actualizarlo ejecuta \"npm update -g autocorector\" si lo has instalado como paquete global, o \"npm update autocorector\" si lo has instalado como paquete local");

					}
				} catch (err) {
					console.error ("No se ha podido comprobar si el autoCOREctor está utilizado. La versión instalada es la " + currentVersion);
				}
				process.exit(0);
				return;
			case "--upload":
			case "-u":
				isUpload = true;
				return;
			default:
				if (i === myArgs.length - 1) {
					console.log("No se reconoce la opción " + arg );
					console.log("\nPara obtener ayuda sobre las opciones disponibles ejecuta \"autocorector -h\" (o \"npx autocorector -h\" si lo has instalado como paquete local)");
					process.exit(0);
				} else {
					console.log("No se reconoce la opción " + arg);
				}
		}
	}
})()

if (opsys == "darwin") { // Mac
	suffix= "MacOS";
} else if (opsys == "win32" || opsys == "win64") { // Win
	suffix = "Windows.exe";
} 

console.log("\nOS detectado: " +  suffix.split(".")[0]);
var cmd = __dirname + "/corrector-" + suffix.toLowerCase();
spawn(cmd, isUpload ? ["upload"] : [] ,{stdio: 'inherit'});